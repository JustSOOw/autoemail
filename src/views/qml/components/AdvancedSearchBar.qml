/*
 * È´òÁ∫ßÊêúÁ¥¢Ê†èÁªÑ‰ª∂
 * ÊîØÊåÅÂÆûÊó∂ÊêúÁ¥¢„ÄÅÊêúÁ¥¢ÂéÜÂè≤„ÄÅÈ´òÁ∫ßÁ≠õÈÄâ„ÄÅÁªìÊûúÈ´ò‰∫ÆÁ≠âÂäüËÉΩ
 */

import QtQuick 2.15
import QtQuick.Controls 2.15
import QtQuick.Layouts 1.15
import QtGraphicalEffects 1.15

Rectangle {
    id: root

    // ==================== Ëá™ÂÆö‰πâÂ±ûÊÄß ====================
    
    property string searchText: ""
    property var searchHistory: []
    property var searchSuggestions: []
    property bool showHistory: true
    property bool showSuggestions: true
    property bool enableAdvancedFilter: true
    property bool isSearching: false
    property int maxHistoryItems: 10
    property int searchDelay: 300
    
    // ==================== ‰ø°Âè∑ ====================
    
    signal searchRequested(string query, var filters)
    signal searchCleared()
    signal historyItemSelected(string query)
    signal advancedFilterRequested()

    // ==================== Âü∫Á°ÄÊ†∑Âºè ====================
    
    implicitHeight: 48
    color: ThemeManager.colors.surface
    radius: DesignSystem.radius.lg
    border.width: searchField.activeFocus ? 2 : 1
    border.color: searchField.activeFocus ? DesignSystem.colors.primary : ThemeManager.colors.outline
    
    // Èò¥ÂΩ±ÊïàÊûú
    layer.enabled: searchField.activeFocus
    layer.effect: DropShadow {
        horizontalOffset: 0
        verticalOffset: 2
        radius: 8
        color: Qt.rgba(DesignSystem.colors.primary.r, 
                      DesignSystem.colors.primary.g, 
                      DesignSystem.colors.primary.b, 0.2)
        spread: 0
    }

    RowLayout {
        anchors.fill: parent
        anchors.margins: DesignSystem.spacing.sm
        spacing: DesignSystem.spacing.sm

        // ÊêúÁ¥¢ÂõæÊ†á
        Label {
            text: root.isSearching ? "‚è≥" : "üîç"
            font.pixelSize: DesignSystem.icons.size.medium
            color: searchField.activeFocus ? DesignSystem.colors.primary : ThemeManager.colors.onSurfaceVariant
            
            // ÊêúÁ¥¢‰∏≠ÁöÑÊóãËΩ¨Âä®Áîª
            RotationAnimation {
                target: parent
                running: root.isSearching
                loops: Animation.Infinite
                from: 0
                to: 360
                duration: 1000
            }
        }

        // ÊêúÁ¥¢ËæìÂÖ•Ê°Ü
        TextField {
            id: searchField
            Layout.fillWidth: true
            placeholderText: "ÊêúÁ¥¢ÈÇÆÁÆ±„ÄÅÊ†áÁ≠æÊàñÂ§áÊ≥®..."
            font.pixelSize: DesignSystem.typography.body.medium
            color: ThemeManager.colors.onSurface
            
            background: Rectangle {
                color: "transparent"
            }
            
            text: root.searchText
            
            onTextChanged: {
                root.searchText = text
                searchTimer.restart()
                
                if (text.length > 0) {
                    updateSuggestions()
                    if (root.showSuggestions && searchSuggestions.length > 0) {
                        suggestionsPopup.open()
                    }
                } else {
                    suggestionsPopup.close()
                }
            }
            
            onActiveFocusChanged: {
                if (activeFocus && text.length === 0 && root.showHistory && searchHistory.length > 0) {
                    historyPopup.open()
                }
            }
            
            Keys.onEscapePressed: {
                text = ""
                focus = false
                suggestionsPopup.close()
                historyPopup.close()
            }
            
            Keys.onReturnPressed: {
                performSearch()
                suggestionsPopup.close()
                historyPopup.close()
            }
            
            Keys.onDownPressed: {
                if (suggestionsPopup.opened) {
                    suggestionsList.forceActiveFocus()
                } else if (historyPopup.opened) {
                    historyList.forceActiveFocus()
                }
            }
        }

        // Ê∏ÖÈô§ÊåâÈíÆ
        EnhancedButton {
            visible: searchField.text.length > 0
            variant: EnhancedButton.ButtonVariant.Text
            iconText: "‚úï"
            implicitWidth: 32
            implicitHeight: 32
            
            onClicked: {
                searchField.text = ""
                searchField.forceActiveFocus()
                root.searchCleared()
            }
        }

        // È´òÁ∫ßÁ≠õÈÄâÊåâÈíÆ
        EnhancedButton {
            visible: root.enableAdvancedFilter
            variant: EnhancedButton.ButtonVariant.Text
            iconText: "üîΩ"
            implicitWidth: 32
            implicitHeight: 32
            ToolTip.text: "È´òÁ∫ßÁ≠õÈÄâ"
            
            onClicked: {
                root.advancedFilterRequested()
                advancedFilterPopup.open()
            }
        }
    }

    // ==================== ÊêúÁ¥¢ÂÆöÊó∂Âô® ====================
    
    Timer {
        id: searchTimer
        interval: root.searchDelay
        onTriggered: {
            if (searchField.text.trim().length > 0) {
                performSearch()
            }
        }
    }

    // ==================== ÊêúÁ¥¢Âª∫ËÆÆÂºπÂá∫Ê°Ü ====================
    
    Popup {
        id: suggestionsPopup
        y: root.height + 4
        width: root.width
        height: Math.min(suggestionsList.contentHeight + 20, 200)
        
        background: Rectangle {
            color: ThemeManager.colors.surface
            radius: DesignSystem.radius.md
            border.width: 1
            border.color: ThemeManager.colors.outline
            
            layer.enabled: true
            layer.effect: DropShadow {
                horizontalOffset: 0
                verticalOffset: 4
                radius: 12
                color: DesignSystem.colors.shadow
                spread: 0
            }
        }
        
        ListView {
            id: suggestionsList
            anchors.fill: parent
            anchors.margins: 10
            model: root.searchSuggestions
            
            delegate: ItemDelegate {
                width: suggestionsList.width
                height: 36
                
                contentItem: RowLayout {
                    spacing: DesignSystem.spacing.sm
                    
                    Label {
                        text: "üîç"
                        font.pixelSize: DesignSystem.icons.size.small
                        color: ThemeManager.colors.onSurfaceVariant
                    }
                    
                    Label {
                        Layout.fillWidth: true
                        text: modelData
                        font.pixelSize: DesignSystem.typography.body.medium
                        color: ThemeManager.colors.onSurface
                        elide: Text.ElideRight
                    }
                }
                
                onClicked: {
                    searchField.text = modelData
                    performSearch()
                    suggestionsPopup.close()
                }
            }
        }
    }

    // ==================== ÊêúÁ¥¢ÂéÜÂè≤ÂºπÂá∫Ê°Ü ====================
    
    Popup {
        id: historyPopup
        y: root.height + 4
        width: root.width
        height: Math.min(historyList.contentHeight + 40, 250)
        
        background: Rectangle {
            color: ThemeManager.colors.surface
            radius: DesignSystem.radius.md
            border.width: 1
            border.color: ThemeManager.colors.outline
            
            layer.enabled: true
            layer.effect: DropShadow {
                horizontalOffset: 0
                verticalOffset: 4
                radius: 12
                color: DesignSystem.colors.shadow
                spread: 0
            }
        }
        
        ColumnLayout {
            anchors.fill: parent
            anchors.margins: 10
            spacing: 8
            
            RowLayout {
                Layout.fillWidth: true
                
                Label {
                    text: "ÊêúÁ¥¢ÂéÜÂè≤"
                    font.pixelSize: DesignSystem.typography.label.medium
                    font.weight: DesignSystem.typography.weight.semiBold
                    color: ThemeManager.colors.onSurfaceVariant
                }
                
                Item { Layout.fillWidth: true }
                
                EnhancedButton {
                    variant: EnhancedButton.ButtonVariant.Text
                    text: "Ê∏ÖÁ©∫"
                    font.pixelSize: DesignSystem.typography.label.small
                    implicitHeight: 24
                    
                    onClicked: {
                        clearSearchHistory()
                        historyPopup.close()
                    }
                }
            }
            
            ListView {
                id: historyList
                Layout.fillWidth: true
                Layout.fillHeight: true
                model: root.searchHistory
                
                delegate: ItemDelegate {
                    width: historyList.width
                    height: 36
                    
                    contentItem: RowLayout {
                        spacing: DesignSystem.spacing.sm
                        
                        Label {
                            text: "üïí"
                            font.pixelSize: DesignSystem.icons.size.small
                            color: ThemeManager.colors.onSurfaceVariant
                        }
                        
                        Label {
                            Layout.fillWidth: true
                            text: modelData
                            font.pixelSize: DesignSystem.typography.body.medium
                            color: ThemeManager.colors.onSurface
                            elide: Text.ElideRight
                        }
                        
                        EnhancedButton {
                            variant: EnhancedButton.ButtonVariant.Text
                            iconText: "‚úï"
                            implicitWidth: 24
                            implicitHeight: 24
                            
                            onClicked: {
                                removeFromHistory(index)
                            }
                        }
                    }
                    
                    onClicked: {
                        searchField.text = modelData
                        root.historyItemSelected(modelData)
                        performSearch()
                        historyPopup.close()
                    }
                }
            }
        }
    }

    // ==================== È´òÁ∫ßÁ≠õÈÄâÂºπÂá∫Ê°Ü ====================
    
    Popup {
        id: advancedFilterPopup
        y: root.height + 4
        width: 320
        height: 280
        
        background: Rectangle {
            color: ThemeManager.colors.surface
            radius: DesignSystem.radius.lg
            border.width: 1
            border.color: ThemeManager.colors.outline
            
            layer.enabled: true
            layer.effect: DropShadow {
                horizontalOffset: 0
                verticalOffset: 4
                radius: 12
                color: DesignSystem.colors.shadow
                spread: 0
            }
        }
        
        ColumnLayout {
            anchors.fill: parent
            anchors.margins: DesignSystem.spacing.md
            spacing: DesignSystem.spacing.md
            
            Label {
                text: "È´òÁ∫ßÁ≠õÈÄâ"
                font.pixelSize: DesignSystem.typography.headline.small
                font.weight: DesignSystem.typography.weight.semiBold
                color: ThemeManager.colors.onSurface
            }
            
            // Êó•ÊúüËåÉÂõ¥Á≠õÈÄâ
            ColumnLayout {
                Layout.fillWidth: true
                spacing: DesignSystem.spacing.xs
                
                Label {
                    text: "ÂàõÂª∫Êó∂Èó¥"
                    font.pixelSize: DesignSystem.typography.label.medium
                    color: ThemeManager.colors.onSurfaceVariant
                }
                
                RowLayout {
                    Layout.fillWidth: true
                    spacing: DesignSystem.spacing.sm
                    
                    EnhancedTextField {
                        id: startDateField
                        Layout.fillWidth: true
                        placeholderText: "ÂºÄÂßãÊó•Êúü"
                        variant: EnhancedTextField.TextFieldVariant.Outlined
                    }
                    
                    Label {
                        text: "Ëá≥"
                        color: ThemeManager.colors.onSurfaceVariant
                    }
                    
                    EnhancedTextField {
                        id: endDateField
                        Layout.fillWidth: true
                        placeholderText: "ÁªìÊùüÊó•Êúü"
                        variant: EnhancedTextField.TextFieldVariant.Outlined
                    }
                }
            }
            
            // Áä∂ÊÄÅÁ≠õÈÄâ
            ColumnLayout {
                Layout.fillWidth: true
                spacing: DesignSystem.spacing.xs
                
                Label {
                    text: "Áä∂ÊÄÅ"
                    font.pixelSize: DesignSystem.typography.label.medium
                    color: ThemeManager.colors.onSurfaceVariant
                }
                
                Flow {
                    Layout.fillWidth: true
                    spacing: DesignSystem.spacing.xs
                    
                    property var statusOptions: ["ÂÖ®ÈÉ®", "Ê¥ªË∑É", "ÈùûÊ¥ªË∑É", "ÂΩíÊ°£"]
                    
                    Repeater {
                        model: parent.statusOptions
                        
                        CheckBox {
                            text: modelData
                            font.pixelSize: DesignSystem.typography.label.medium
                            checked: modelData === "ÂÖ®ÈÉ®"
                        }
                    }
                }
            }
            
            Item { Layout.fillHeight: true }
            
            // Êìç‰ΩúÊåâÈíÆ
            RowLayout {
                Layout.fillWidth: true
                
                EnhancedButton {
                    text: "ÈáçÁΩÆ"
                    variant: EnhancedButton.ButtonVariant.Outlined
                    Layout.fillWidth: true
                    
                    onClicked: {
                        resetAdvancedFilter()
                    }
                }
                
                EnhancedButton {
                    text: "Â∫îÁî®"
                    variant: EnhancedButton.ButtonVariant.Filled
                    Layout.fillWidth: true
                    
                    onClicked: {
                        applyAdvancedFilter()
                        advancedFilterPopup.close()
                    }
                }
            }
        }
    }

    // ==================== ÊñπÊ≥ï ====================
    
    function performSearch() {
        if (searchField.text.trim().length === 0) {
            root.searchCleared()
            return
        }
        
        root.isSearching = true
        addToHistory(searchField.text.trim())
        
        var filters = getAdvancedFilters()
        root.searchRequested(searchField.text.trim(), filters)
        
        // Ê®°ÊãüÊêúÁ¥¢Âª∂Ëøü
        Qt.callLater(function() {
            root.isSearching = false
        })
    }
    
    function updateSuggestions() {
        // ËøôÈáåÂ∫îËØ•Ê†πÊçÆËæìÂÖ•ÊñáÊú¨ÁîüÊàêÊêúÁ¥¢Âª∫ËÆÆ
        // ÊöÇÊó∂‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
        root.searchSuggestions = [
            searchField.text + "@example.com",
            searchField.text + "@test.com",
            "Ê†áÁ≠æ:" + searchField.text,
            "Â§áÊ≥®:" + searchField.text
        ]
    }
    
    function addToHistory(query) {
        if (root.searchHistory.indexOf(query) === -1) {
            root.searchHistory.unshift(query)
            if (root.searchHistory.length > root.maxHistoryItems) {
                root.searchHistory.pop()
            }
        }
    }
    
    function removeFromHistory(index) {
        root.searchHistory.splice(index, 1)
    }
    
    function clearSearchHistory() {
        root.searchHistory = []
    }
    
    function getAdvancedFilters() {
        return {
            startDate: startDateField.text,
            endDate: endDateField.text,
            status: getSelectedStatuses()
        }
    }
    
    function getSelectedStatuses() {
        // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÁä∂ÊÄÅ
        return ["Ê¥ªË∑É"] // Á§∫‰æã
    }
    
    function resetAdvancedFilter() {
        startDateField.text = ""
        endDateField.text = ""
        // ÈáçÁΩÆÂÖ∂‰ªñÁ≠õÈÄâÊù°‰ª∂
    }
    
    function applyAdvancedFilter() {
        performSearch()
    }
    
    function focusSearchField() {
        searchField.forceActiveFocus()
    }
    
    function clearSearch() {
        searchField.text = ""
        root.searchCleared()
    }
}
