/*
 * Ê†áÁ≠æÁÆ°ÁêÜÈ°µÈù¢
 * Êèê‰æõÊ†áÁ≠æÁöÑÂàõÂª∫„ÄÅÁºñËæë„ÄÅÂà†Èô§ÂíåÁÆ°ÁêÜÂäüËÉΩ
 */

import QtQuick 2.15
import QtQuick.Controls 2.15
import QtQuick.Layouts 1.15
import QtQuick.Controls.Material 2.15
import "../components"

Rectangle {
    id: root
    color: "#f5f5f5"

    // ÂØπÂ§ñÊö¥Èú≤ÁöÑÂ±ûÊÄß
    property var tagList: []
    property bool isLoading: false

    // ÂØπÂ§ñÊö¥Èú≤ÁöÑ‰ø°Âè∑
    signal createTag(string name, string description, string color, string icon)
    signal updateTag(int tagId, var tagData)
    signal deleteTag(int tagId)
    signal refreshTags()

    ColumnLayout {
        anchors.fill: parent
        anchors.margins: 20
        spacing: 20

        // È°µÈù¢Ê†áÈ¢ò
        Label {
            text: "üè∑Ô∏è Ê†áÁ≠æÁÆ°ÁêÜ"
            font.bold: true
            font.pixelSize: 24
            color: "#333"
            Layout.alignment: Qt.AlignHCenter
        }

        // ÂàõÂª∫Ê†áÁ≠æÂå∫Âüü
        Rectangle {
            Layout.fillWidth: true
            height: 150
            color: "white"
            radius: 8
            border.color: "#e0e0e0"

            ColumnLayout {
                anchors.fill: parent
                anchors.margins: 20
                spacing: 15

                Label {
                    text: "‚ûï ÂàõÂª∫Êñ∞Ê†áÁ≠æ"
                    font.bold: true
                    font.pixelSize: 16
                    color: "#333"
                }

                RowLayout {
                    Layout.fillWidth: true
                    spacing: 10

                    TextField {
                        id: tagNameField
                        Layout.preferredWidth: 150
                        placeholderText: "Ê†áÁ≠æÂêçÁß∞"
                        font.pixelSize: 14
                    }

                    TextField {
                        id: tagDescriptionField
                        Layout.fillWidth: true
                        placeholderText: "Ê†áÁ≠æÊèèËø∞"
                        font.pixelSize: 14
                    }

                    ComboBox {
                        id: tagColorCombo
                        Layout.preferredWidth: 100
                        model: ["ËìùËâ≤", "ÁªøËâ≤", "Á∫¢Ëâ≤", "Ê©ôËâ≤", "Á¥´Ëâ≤", "ÈùíËâ≤"]
                        currentIndex: 0
                    }

                    TextField {
                        id: tagIconField
                        Layout.preferredWidth: 80
                        placeholderText: "ÂõæÊ†á"
                        font.pixelSize: 14
                        text: "üè∑Ô∏è"
                    }

                    Button {
                        text: "ÂàõÂª∫"
                        Material.background: Material.Blue
                        enabled: tagNameField.text.trim().length > 0
                        onClicked: {
                            var colorMap = {
                                "ËìùËâ≤": "#2196F3",
                                "ÁªøËâ≤": "#4CAF50", 
                                "Á∫¢Ëâ≤": "#F44336",
                                "Ê©ôËâ≤": "#FF9800",
                                "Á¥´Ëâ≤": "#9C27B0",
                                "ÈùíËâ≤": "#00BCD4"
                            }
                            
                            root.createTag(
                                tagNameField.text.trim(),
                                tagDescriptionField.text.trim(),
                                colorMap[tagColorCombo.currentText] || "#2196F3",
                                tagIconField.text.trim() || "üè∑Ô∏è"
                            )
                            
                            // Ê∏ÖÁ©∫ËæìÂÖ•Â≠óÊÆµ
                            tagNameField.text = ""
                            tagDescriptionField.text = ""
                            tagIconField.text = "üè∑Ô∏è"
                            tagColorCombo.currentIndex = 0
                        }
                    }
                }
            }
        }

        // Ê†áÁ≠æÂàóË°®Âå∫Âüü
        Rectangle {
            Layout.fillWidth: true
            Layout.fillHeight: true
            color: "white"
            radius: 8
            border.color: "#e0e0e0"

            ColumnLayout {
                anchors.fill: parent
                anchors.margins: 20
                spacing: 15

                // ÂàóË°®Ê†áÈ¢òÊ†è
                RowLayout {
                    Layout.fillWidth: true
                    spacing: 10

                    Label {
                        text: "Ê†áÁ≠æÂàóË°®"
                        font.bold: true
                        font.pixelSize: 16
                        color: "#333"
                    }

                    Item { Layout.fillWidth: true }

                    Button {
                        text: "üîÑ Âà∑Êñ∞"
                        Material.background: Material.Green
                        onClicked: root.refreshTags()
                    }

                    Label {
                        text: "ÂÖ± " + root.tagList.length + " ‰∏™Ê†áÁ≠æ"
                        font.pixelSize: 14
                        color: "#666"
                    }
                }

                // Âä†ËΩΩÊåáÁ§∫Âô®
                LoadingIndicator {
                    Layout.fillWidth: true
                    Layout.fillHeight: true
                    running: root.isLoading
                    message: "Ê≠£Âú®Âä†ËΩΩÊ†áÁ≠æÂàóË°®..."
                    visible: root.isLoading
                }

                // Ê†áÁ≠æÂàóË°®
                ScrollView {
                    Layout.fillWidth: true
                    Layout.fillHeight: true
                    visible: !root.isLoading

                    ListView {
                        id: tagListView
                        model: root.tagList
                        spacing: 8

                        delegate: Rectangle {
                            width: tagListView.width
                            height: 80
                            color: "#f8f9fa"
                            radius: 6
                            border.color: "#e9ecef"

                            RowLayout {
                                anchors.fill: parent
                                anchors.margins: 15
                                spacing: 15

                                // Ê†áÁ≠æÂõæÊ†áÂíåÈ¢úËâ≤
                                Rectangle {
                                    width: 40
                                    height: 40
                                    color: modelData.color || "#2196F3"
                                    radius: 20

                                    Label {
                                        anchors.centerIn: parent
                                        text: modelData.icon || "üè∑Ô∏è"
                                        font.pixelSize: 16
                                    }
                                }

                                // Ê†áÁ≠æ‰ø°ÊÅØ
                                ColumnLayout {
                                    Layout.fillWidth: true
                                    spacing: 5

                                    Label {
                                        text: modelData.name || ""
                                        font.pixelSize: 14
                                        font.bold: true
                                        color: "#333"
                                    }

                                    RowLayout {
                                        spacing: 10

                                        Label {
                                            text: modelData.description || "Êó†ÊèèËø∞"
                                            font.pixelSize: 12
                                            color: "#666"
                                        }

                                        Label {
                                            text: "‰ΩøÁî®Ê¨°Êï∞: " + (modelData.usage_count || 0)
                                            font.pixelSize: 12
                                            color: "#666"
                                        }

                                        Label {
                                            text: "ÂàõÂª∫: " + (modelData.created_at ? new Date(modelData.created_at).toLocaleDateString() : "")
                                            font.pixelSize: 12
                                            color: "#666"
                                        }
                                    }
                                }

                                // Êìç‰ΩúÊåâÈíÆ
                                RowLayout {
                                    spacing: 5

                                    Button {
                                        text: "‚úèÔ∏è"
                                        font.pixelSize: 12
                                        implicitWidth: 30
                                        implicitHeight: 30
                                        ToolTip.text: "ÁºñËæë"
                                        onClicked: {
                                            editTagDialog.tagData = modelData
                                            editTagDialog.open()
                                        }
                                    }

                                    Button {
                                        text: "üóëÔ∏è"
                                        font.pixelSize: 12
                                        implicitWidth: 30
                                        implicitHeight: 30
                                        Material.background: Material.Red
                                        ToolTip.text: "Âà†Èô§"
                                        enabled: (modelData.usage_count || 0) === 0
                                        onClicked: {
                                            deleteTagDialog.tagId = modelData.id
                                            deleteTagDialog.tagName = modelData.name
                                            deleteTagDialog.open()
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                // Á©∫Áä∂ÊÄÅÊèêÁ§∫
                ColumnLayout {
                    Layout.fillWidth: true
                    Layout.fillHeight: true
                    visible: !root.isLoading && root.tagList.length === 0
                    spacing: 20

                    Label {
                        text: "üè∑Ô∏è"
                        font.pixelSize: 48
                        color: "#ccc"
                        Layout.alignment: Qt.AlignHCenter
                    }

                    Label {
                        text: "ÊöÇÊó†Ê†áÁ≠æ"
                        font.pixelSize: 16
                        color: "#666"
                        Layout.alignment: Qt.AlignHCenter
                    }

                    Label {
                        text: "ÂàõÂª∫Á¨¨‰∏Ä‰∏™Ê†áÁ≠æÊù•ÂºÄÂßãÁÆ°ÁêÜÊÇ®ÁöÑÈÇÆÁÆ±"
                        font.pixelSize: 14
                        color: "#999"
                        Layout.alignment: Qt.AlignHCenter
                    }
                }
            }
        }
    }

    // ÁºñËæëÊ†áÁ≠æÂØπËØùÊ°Ü
    Dialog {
        id: editTagDialog
        title: "ÁºñËæëÊ†áÁ≠æ"
        modal: true
        anchors.centerIn: parent
        width: 400

        property var tagData: ({})

        ColumnLayout {
            spacing: 15
            width: parent.width

            TextField {
                id: editNameField
                Layout.fillWidth: true
                placeholderText: "Ê†áÁ≠æÂêçÁß∞"
                text: editTagDialog.tagData.name || ""
            }

            TextField {
                id: editDescriptionField
                Layout.fillWidth: true
                placeholderText: "Ê†áÁ≠æÊèèËø∞"
                text: editTagDialog.tagData.description || ""
            }

            TextField {
                id: editIconField
                Layout.fillWidth: true
                placeholderText: "ÂõæÊ†á"
                text: editTagDialog.tagData.icon || "üè∑Ô∏è"
            }

            RowLayout {
                Layout.alignment: Qt.AlignRight
                spacing: 10

                Button {
                    text: "ÂèñÊ∂à"
                    onClicked: editTagDialog.close()
                }

                Button {
                    text: "‰øùÂ≠ò"
                    Material.background: Material.Blue
                    enabled: editNameField.text.trim().length > 0
                    onClicked: {
                        var updatedData = {
                            id: editTagDialog.tagData.id,
                            name: editNameField.text.trim(),
                            description: editDescriptionField.text.trim(),
                            icon: editIconField.text.trim() || "üè∑Ô∏è"
                        }
                        root.updateTag(editTagDialog.tagData.id, updatedData)
                        editTagDialog.close()
                    }
                }
            }
        }
    }

    // Âà†Èô§Á°ÆËÆ§ÂØπËØùÊ°Ü
    ConfirmDialog {
        id: deleteTagDialog
        
        property int tagId: 0
        property string tagName: ""
        
        titleText: "Á°ÆËÆ§Âà†Èô§Ê†áÁ≠æ"
        messageText: "Á°ÆÂÆöË¶ÅÂà†Èô§Ê†áÁ≠æ \"" + tagName + "\" ÂêóÔºü\nÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ"
        destructive: true
        
        onConfirmed: {
            root.deleteTag(tagId)
        }
    }
}
