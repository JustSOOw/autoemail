# Developåˆ†æ”¯æŒç»­é›†æˆ
# å½“ä»£ç æ¨é€åˆ°developåˆ†æ”¯æ—¶è§¦å‘
name: Developåˆ†æ”¯CI

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  # å®Œæ•´æµ‹è¯•å¥—ä»¶
  full-test-suite:
    name: å®Œæ•´æµ‹è¯•å¥—ä»¶
    runs-on: ubuntu-22.04  # æ˜ç¡®æŒ‡å®šUbuntu 22.04ä»¥é¿å…Ubuntu 24.04å…¼å®¹æ€§é—®é¢˜

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v4  # å‡çº§åˆ°v4ç‰ˆæœ¬
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-cov pytest-xvfb flake8 black isort
        
    - name: è¿è¡Œå®Œæ•´æµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶..."
        python scripts/run_tests.py
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=html
        
    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: develop
        name: develop-coverage

    - name: ä¿å­˜è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/

  # ç®€åŒ–å¤šå¹³å°æ„å»ºæµ‹è¯• - åªæµ‹è¯•æ ¸å¿ƒç»„åˆ
  multi-platform-build:
    name: å¤šå¹³å°æ„å»ºæµ‹è¯•
    strategy:
      matrix:
        os: [ubuntu-22.04, windows-latest]  # æ˜ç¡®æŒ‡å®šUbuntu 22.04
        python-version: ['3.11']  # åªæµ‹è¯•ä¸»è¦Pythonç‰ˆæœ¬

    runs-on: ${{ matrix.os }}
    continue-on-error: true  # å…è®¸å¤±è´¥

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Linux)
      if: matrix.os == 'ubuntu-22.04'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1-mesa-glx \
          libglib2.0-0 \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-xfixes0

    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: è¿è¡ŒåŸºç¡€æµ‹è¯•
      run: |
        echo "Running tests on ${{ matrix.os }} Python ${{ matrix.python-version }}..."
        python scripts/run_tests.py

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-22.04  # æ˜ç¡®æŒ‡å®šUbuntu 22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-benchmark memory-profiler
        
    - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ€§èƒ½æµ‹è¯•è„šæœ¬
        python -c "
        import time
        import psutil
        import os
        
        print('ğŸ“Š ç³»ç»Ÿæ€§èƒ½åŸºå‡†æµ‹è¯•')
        print(f'CPUæ ¸å¿ƒæ•°: {psutil.cpu_count()}')
        print(f'å†…å­˜æ€»é‡: {psutil.virtual_memory().total / 1024**3:.2f} GB')
        
        # æµ‹è¯•å¯¼å…¥æ—¶é—´
        start_time = time.time()
        try:
            import sys
            sys.path.insert(0, 'src')
            from models.email_model import EmailModel
            from models.config_model import ConfigModel
            from services.database_service import DatabaseService
            import_time = time.time() - start_time
            print(f'âœ… æ¨¡å—å¯¼å…¥æ—¶é—´: {import_time:.3f}s')
        except Exception as e:
            print(f'âŒ æ¨¡å—å¯¼å…¥å¤±è´¥: {e}')
        "

  # ç®€åŒ–ä»£ç è´¨é‡åˆ†æ
  code-analysis:
    name: ä»£ç è´¨é‡åˆ†æ
    runs-on: ubuntu-22.04  # æ˜ç¡®æŒ‡å®šUbuntu 22.04
    continue-on-error: true  # å…è®¸å¤±è´¥

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: åŸºç¡€ä»£ç æ£€æŸ¥
      run: |
        echo "ğŸ“ˆ åŸºç¡€ä»£ç è´¨é‡æ£€æŸ¥..."
        python -c "
        import os
        from pathlib import Path

        src_dir = Path('src')
        if src_dir.exists():
            py_files = list(src_dir.rglob('*.py'))
            print(f'âœ… æ‰¾åˆ° {len(py_files)} ä¸ªPythonæ–‡ä»¶')

            total_lines = 0
            for py_file in py_files:
                try:
                    with open(py_file, 'r', encoding='utf-8') as f:
                        lines = len(f.readlines())
                        total_lines += lines
                except:
                    continue

            print(f'âœ… æ€»ä»£ç è¡Œæ•°: {total_lines}')
            print('âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ')
        else:
            print('âš ï¸ srcç›®å½•ä¸å­˜åœ¨')
        "

  # ç®€åŒ–å®‰å…¨æ‰«æ - åªè¿è¡Œæœ¬åœ°è„šæœ¬
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-22.04  # æ˜ç¡®æŒ‡å®šUbuntu 22.04
    continue-on-error: true  # å…è®¸å¤±è´¥

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: è¿è¡Œæœ¬åœ°å®‰å…¨æ£€æŸ¥
      run: |
        echo "ğŸ”’ è¿è¡Œæœ¬åœ°å®‰å…¨æ£€æŸ¥..."
        python scripts/security_check.py

  # æ–‡æ¡£æ£€æŸ¥
  documentation-check:
    name: æ–‡æ¡£æ£€æŸ¥
    runs-on: ubuntu-22.04  # æ˜ç¡®æŒ‡å®šUbuntu 22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§
      run: |
        echo "ğŸ“š æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§..."
        
        # æ£€æŸ¥å¿…è¦æ–‡æ¡£æ˜¯å¦å­˜åœ¨
        required_docs=("README.md" "GEMINI.md" "docs/architecture-design.md" "docs/development-plan.md")
        
        for doc in "${required_docs[@]}"; do
          if [[ -f "$doc" ]]; then
            echo "âœ… æ–‡æ¡£å­˜åœ¨: $doc"
          else
            echo "âŒ ç¼ºå°‘æ–‡æ¡£: $doc"
            exit 1
          fi
        done
        
        # æ£€æŸ¥READMEæ–‡æ¡£çš„åŸºæœ¬ç»“æ„
        if grep -q "## ğŸ“§ é¡¹ç›®ç®€ä»‹" README.md && \
           grep -q "## âœ¨ ä¸»è¦åŠŸèƒ½" README.md && \
           grep -q "## ğŸ—ï¸ æŠ€æœ¯æ¶æ„" README.md; then
          echo "âœ… READMEæ–‡æ¡£ç»“æ„å®Œæ•´"
        else
          echo "âŒ READMEæ–‡æ¡£ç»“æ„ä¸å®Œæ•´"
          exit 1
        fi

  # é€šçŸ¥ - å®½æ¾æ¨¡å¼
  notification:
    name: æ„å»ºé€šçŸ¥
    runs-on: ubuntu-22.04  # æ˜ç¡®æŒ‡å®šUbuntu 22.04
    needs: [full-test-suite, multi-platform-build, performance-test, code-analysis, security-scan, documentation-check]
    if: always()

    steps:
    - name: æ„å»ºç»“æœé€šçŸ¥
      run: |
        echo "ğŸ“¢ Developåˆ†æ”¯CIæ„å»ºå®Œæˆ"
        echo "=========================="

        # åªæ£€æŸ¥æ ¸å¿ƒæµ‹è¯•æ˜¯å¦é€šè¿‡
        if [[ "${{ needs.full-test-suite.result }}" == "success" ]]; then
          echo "âœ… æ ¸å¿ƒæµ‹è¯•é€šè¿‡"
          echo "ğŸ‰ Developåˆ†æ”¯çŠ¶æ€è‰¯å¥½ï¼"
        else
          echo "âŒ æ ¸å¿ƒæµ‹è¯•å¤±è´¥ï¼Œéœ€è¦ä¿®å¤"
        fi

        # æ˜¾ç¤ºå…¶ä»–æ£€æŸ¥çŠ¶æ€ï¼ˆä½†ä¸å½±å“æ•´ä½“ç»“æœï¼‰
        echo ""
        echo "å…¶ä»–æ£€æŸ¥çŠ¶æ€:"
        [[ "${{ needs.multi-platform-build.result }}" == "success" ]] && echo "  âœ… å¤šå¹³å°æ„å»ºæµ‹è¯•" || echo "  âš ï¸ å¤šå¹³å°æ„å»ºæµ‹è¯•"
        [[ "${{ needs.performance-test.result }}" == "success" ]] && echo "  âœ… æ€§èƒ½æµ‹è¯•" || echo "  âš ï¸ æ€§èƒ½æµ‹è¯•"
        [[ "${{ needs.code-analysis.result }}" == "success" ]] && echo "  âœ… ä»£ç è´¨é‡åˆ†æ" || echo "  âš ï¸ ä»£ç è´¨é‡åˆ†æ"
        [[ "${{ needs.security-scan.result }}" == "success" ]] && echo "  âœ… å®‰å…¨æ‰«æ" || echo "  âš ï¸ å®‰å…¨æ‰«æ"
        [[ "${{ needs.documentation-check.result }}" == "success" ]] && echo "  âœ… æ–‡æ¡£æ£€æŸ¥" || echo "  âš ï¸ æ–‡æ¡£æ£€æŸ¥"
