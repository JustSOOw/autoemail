# Developåˆ†æ”¯æŒç»­é›†æˆ
# å½“ä»£ç æ¨é€åˆ°developåˆ†æ”¯æ—¶è§¦å‘
name: Developåˆ†æ”¯CI

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  # å®Œæ•´æµ‹è¯•å¥—ä»¶
  full-test-suite:
    name: å®Œæ•´æµ‹è¯•å¥—ä»¶
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-xvfb flake8 black isort
        
    - name: è¿è¡Œå®Œæ•´æµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶..."
        python scripts/run_tests.py
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=html
        
    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: develop
        name: develop-coverage
        
    - name: ä¿å­˜è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: htmlcov/

  # å¤šå¹³å°æ„å»ºæµ‹è¯•
  multi-platform-build:
    name: å¤šå¹³å°æ„å»ºæµ‹è¯•
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11']
        
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: è¿è¡ŒåŸºç¡€æµ‹è¯•
      run: |
        echo "ğŸ§ª åœ¨ ${{ matrix.os }} Python ${{ matrix.python-version }} ä¸Šè¿è¡Œæµ‹è¯•..."
        python scripts/run_tests.py

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-benchmark memory-profiler
        
    - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ€§èƒ½æµ‹è¯•è„šæœ¬
        python -c "
        import time
        import psutil
        import os
        
        print('ğŸ“Š ç³»ç»Ÿæ€§èƒ½åŸºå‡†æµ‹è¯•')
        print(f'CPUæ ¸å¿ƒæ•°: {psutil.cpu_count()}')
        print(f'å†…å­˜æ€»é‡: {psutil.virtual_memory().total / 1024**3:.2f} GB')
        
        # æµ‹è¯•å¯¼å…¥æ—¶é—´
        start_time = time.time()
        try:
            import sys
            sys.path.insert(0, 'src')
            from models.email_model import EmailModel
            from models.config_model import ConfigModel
            from services.database_service import DatabaseService
            import_time = time.time() - start_time
            print(f'âœ… æ¨¡å—å¯¼å…¥æ—¶é—´: {import_time:.3f}s')
        except Exception as e:
            print(f'âŒ æ¨¡å—å¯¼å…¥å¤±è´¥: {e}')
        "

  # ä»£ç è´¨é‡åˆ†æ
  code-analysis:
    name: ä»£ç è´¨é‡åˆ†æ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…åˆ†æå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pylint mypy radon complexity
        
    - name: ä»£ç å¤æ‚åº¦åˆ†æ
      run: |
        echo "ğŸ“ˆ åˆ†æä»£ç å¤æ‚åº¦..."
        radon cc src/ -a -nc
        radon mi src/ -nc
        
    - name: ç±»å‹æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œç±»å‹æ£€æŸ¥..."
        mypy src/ --ignore-missing-imports --no-strict-optional || true
        
    - name: ä»£ç è´¨é‡è¯„åˆ†
      run: |
        echo "â­ ä»£ç è´¨é‡è¯„åˆ†..."
        pylint src/ --exit-zero --output-format=text --reports=yes

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…å®‰å…¨å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit semgrep
        
    - name: ä¾èµ–æ¼æ´æ‰«æ
      run: |
        echo "ğŸ”’ æ‰«æä¾èµ–æ¼æ´..."
        safety check -r requirements.txt --json --output safety-report.json || true
        safety check -r requirements.txt
        
    - name: ä»£ç å®‰å…¨æ‰«æ
      run: |
        echo "ğŸ›¡ï¸ æ‰«æä»£ç å®‰å…¨é—®é¢˜..."
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/
        
    - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json

  # æ–‡æ¡£æ£€æŸ¥
  documentation-check:
    name: æ–‡æ¡£æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§
      run: |
        echo "ğŸ“š æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§..."
        
        # æ£€æŸ¥å¿…è¦æ–‡æ¡£æ˜¯å¦å­˜åœ¨
        required_docs=("README.md" "GEMINI.md" "docs/architecture-design.md" "docs/development-plan.md")
        
        for doc in "${required_docs[@]}"; do
          if [[ -f "$doc" ]]; then
            echo "âœ… æ–‡æ¡£å­˜åœ¨: $doc"
          else
            echo "âŒ ç¼ºå°‘æ–‡æ¡£: $doc"
            exit 1
          fi
        done
        
        # æ£€æŸ¥READMEæ–‡æ¡£çš„åŸºæœ¬ç»“æ„
        if grep -q "## ğŸ“§ é¡¹ç›®ç®€ä»‹" README.md && \
           grep -q "## âœ¨ ä¸»è¦åŠŸèƒ½" README.md && \
           grep -q "## ğŸ—ï¸ æŠ€æœ¯æ¶æ„" README.md; then
          echo "âœ… READMEæ–‡æ¡£ç»“æ„å®Œæ•´"
        else
          echo "âŒ READMEæ–‡æ¡£ç»“æ„ä¸å®Œæ•´"
          exit 1
        fi

  # é€šçŸ¥
  notification:
    name: æ„å»ºé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [full-test-suite, multi-platform-build, performance-test, code-analysis, security-scan, documentation-check]
    if: always()
    
    steps:
    - name: æ„å»ºç»“æœé€šçŸ¥
      run: |
        echo "ğŸ“¢ Developåˆ†æ”¯CIæ„å»ºå®Œæˆ"
        echo "=========================="
        
        if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          echo "å¤±è´¥çš„ä»»åŠ¡:"
          [[ "${{ needs.full-test-suite.result }}" == "failure" ]] && echo "  - å®Œæ•´æµ‹è¯•å¥—ä»¶"
          [[ "${{ needs.multi-platform-build.result }}" == "failure" ]] && echo "  - å¤šå¹³å°æ„å»ºæµ‹è¯•"
          [[ "${{ needs.performance-test.result }}" == "failure" ]] && echo "  - æ€§èƒ½æµ‹è¯•"
          [[ "${{ needs.code-analysis.result }}" == "failure" ]] && echo "  - ä»£ç è´¨é‡åˆ†æ"
          [[ "${{ needs.security-scan.result }}" == "failure" ]] && echo "  - å®‰å…¨æ‰«æ"
          [[ "${{ needs.documentation-check.result }}" == "failure" ]] && echo "  - æ–‡æ¡£æ£€æŸ¥"
        else
          echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œdevelopåˆ†æ”¯çŠ¶æ€è‰¯å¥½ï¼"
        fi
