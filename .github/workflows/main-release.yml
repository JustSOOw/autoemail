# Mainåˆ†æ”¯å‘å¸ƒæµç¨‹
# å½“ä»£ç åˆå¹¶åˆ°mainåˆ†æ”¯æ—¶è§¦å‘å‘å¸ƒæµç¨‹
name: Mainåˆ†æ”¯å‘å¸ƒ

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  # å‘å¸ƒå‰æ£€æŸ¥
  pre-release-check:
    name: å‘å¸ƒå‰æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
        
    - name: è¿è¡Œå®Œæ•´æµ‹è¯•
      run: |
        echo "ðŸ§ª è¿è¡Œå‘å¸ƒå‰æµ‹è¯•..."
        python scripts/run_tests.py
        pytest tests/ -v --cov=src
        
    - name: æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯
      run: |
        echo "ðŸ“‹ æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥é€»è¾‘
        echo "å½“å‰æäº¤: ${{ github.sha }}"
        echo "åˆ†æ”¯: ${{ github.ref }}"

  # æž„å»ºå‘å¸ƒç‰ˆæœ¬
  build-release:
    name: æž„å»ºå‘å¸ƒç‰ˆæœ¬
    needs: pre-release-check
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: æž„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        echo "ðŸ”¨ æž„å»º ${{ matrix.os }} ç‰ˆæœ¬..."
        python scripts/build.py
        
    - name: æ‰“åŒ…å‘å¸ƒæ–‡ä»¶
      run: |
        echo "ðŸ“¦ æ‰“åŒ…å‘å¸ƒæ–‡ä»¶..."
        # æ ¹æ®æ“ä½œç³»ç»Ÿåˆ›å»ºä¸åŒçš„æ‰“åŒ…å‘½ä»¤
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          7z a EmailDomainManager-${{ matrix.os }}.zip dist/
        else
          tar -czf EmailDomainManager-${{ matrix.os }}.tar.gz dist/
        fi
      shell: bash
        
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: build-${{ matrix.os }}
        path: |
          EmailDomainManager-${{ matrix.os }}.*
          dist/

  # åˆ›å»ºGitHub Release
  create-release:
    name: åˆ›å»ºGitHub Release
    needs: build-release
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
      run: |
        echo "ðŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž..."
        
        # èŽ·å–æœ€æ–°çš„æäº¤ä¿¡æ¯ä½œä¸ºå‘å¸ƒè¯´æ˜Ž
        RELEASE_NOTES=$(git log --pretty=format:"- %s" -10)
        
        cat > release-notes.md << EOF
        # åŸŸåé‚®ç®±ç®¡ç†å™¨ å‘å¸ƒç‰ˆæœ¬
        
        ## ðŸŽ‰ æ–°åŠŸèƒ½å’Œæ”¹è¿›
        
        $RELEASE_NOTES
        
        ## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        
        - **Windowsç”¨æˆ·**: ä¸‹è½½ \`EmailDomainManager-windows-latest.zip\`
        - **Linuxç”¨æˆ·**: ä¸‹è½½ \`EmailDomainManager-ubuntu-latest.tar.gz\`
        - **macOSç”¨æˆ·**: ä¸‹è½½ \`EmailDomainManager-macos-latest.tar.gz\`
        
        ## ðŸš€ å®‰è£…è¯´æ˜Ž
        
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…
        2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
        3. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶å³å¯ä½¿ç”¨
        
        ## ðŸ“‹ ç³»ç»Ÿè¦æ±‚
        
        - Windows 10+ / Linux / macOS 10.14+
        - 4GB+ RAM
        - 100MB+ ç£ç›˜ç©ºé—´
        
        ## ðŸ› å·²çŸ¥é—®é¢˜
        
        å¦‚æœ‰é—®é¢˜è¯·åœ¨ Issues ä¸­åé¦ˆã€‚
        EOF
        
    - name: ç¡®å®šç‰ˆæœ¬å·
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          # è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·ï¼švå¹´.æœˆ.æ—¥-æž„å»ºå·
          VERSION="v$(date +'%Y.%m.%d')-${{ github.run_number }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"
        
    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: åŸŸåé‚®ç®±ç®¡ç†å™¨ ${{ steps.version.outputs.version }}
        body_path: release-notes.md
        draft: false
        prerelease: false
        files: |
          build-windows-latest/EmailDomainManager-windows-latest.zip
          build-ubuntu-latest/EmailDomainManager-ubuntu-latest.tar.gz
          build-macos-latest/EmailDomainManager-macos-latest.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # éƒ¨ç½²æ–‡æ¡£
  deploy-docs:
    name: éƒ¨ç½²æ–‡æ¡£
    needs: create-release
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…æ–‡æ¡£å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install mkdocs mkdocs-material
        
    - name: æž„å»ºæ–‡æ¡£
      run: |
        echo "ðŸ“š æž„å»ºé¡¹ç›®æ–‡æ¡£..."
        
        # åˆ›å»ºmkdocsé…ç½®
        cat > mkdocs.yml << EOF
        site_name: åŸŸåé‚®ç®±ç®¡ç†å™¨
        site_description: åŸºäºŽPyQt6çš„åŸŸåé‚®ç®±ç®¡ç†å·¥å…·
        
        nav:
          - é¦–é¡µ: README.md
          - æž¶æž„è®¾è®¡: docs/architecture-design.md
          - å¼€å‘è®¡åˆ’: docs/development-plan.md
          - APIè§„èŒƒ: docs/api-specification.md
          - æ•°æ®åº“è®¾è®¡: docs/database-schema.md
          - UIè®¾è®¡: docs/ui-mockups.md
        
        theme:
          name: material
          language: zh
          palette:
            primary: blue
            accent: blue
        EOF
        
        mkdocs build
        
    - name: éƒ¨ç½²åˆ°GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site

  # å‘å¸ƒé€šçŸ¥
  release-notification:
    name: å‘å¸ƒé€šçŸ¥
    needs: [create-release, deploy-docs]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: å‘å¸ƒç»“æžœé€šçŸ¥
      run: |
        echo "ðŸŽ‰ Mainåˆ†æ”¯å‘å¸ƒæµç¨‹å®Œæˆ"
        echo "========================"
        
        if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
          echo "âŒ å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºçŽ°é—®é¢˜"
          echo "å¤±è´¥çš„ä»»åŠ¡:"
          [[ "${{ needs.create-release.result }}" == "failure" ]] && echo "  - åˆ›å»ºRelease"
          [[ "${{ needs.deploy-docs.result }}" == "failure" ]] && echo "  - éƒ¨ç½²æ–‡æ¡£"
        else
          echo "ðŸŽ‰ å‘å¸ƒæˆåŠŸå®Œæˆï¼"
          echo "ðŸ“¦ æ–°ç‰ˆæœ¬å·²å‘å¸ƒåˆ°GitHub Releases"
          echo "ðŸ“š æ–‡æ¡£å·²æ›´æ–°åˆ°GitHub Pages"
        fi
