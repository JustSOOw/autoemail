# Mainåˆ†æ”¯è‡ªåŠ¨æ‰“åŒ…å‘å¸ƒæµç¨‹
# å½“å‘mainåˆ†æ”¯æäº¤PRæ—¶è§¦å‘å¤šå¹³å°å¤šæž¶æž„çš„è‡ªåŠ¨æ‰“åŒ…å’Œå‘å¸ƒ
name: è‡ªåŠ¨æ‰“åŒ…å‘å¸ƒ

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'


# è®¾ç½®GitHub Actionsæƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»ºreleaseå’Œä¸Šä¼ æ–‡ä»¶
  pages: write     # å…è®¸éƒ¨ç½²åˆ°GitHub Pages
  id-token: write  # å…è®¸OIDC tokenå†™å…¥

jobs:
  # å‘å¸ƒå‰æ£€æŸ¥
  pre-release-check:
    name: å‘å¸ƒå‰æ£€æŸ¥
    runs-on: ubuntu-22.04  # æ˜Žç¡®æŒ‡å®šUbuntu 22.04ä»¥é¿å…Ubuntu 24.04å…¼å®¹æ€§é—®é¢˜

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: è¿è¡Œå®Œæ•´æµ‹è¯•
      run: |
        echo "ðŸ§ª è¿è¡Œå‘å¸ƒå‰æµ‹è¯•..."
        python scripts/run_tests.py
        pytest tests/ -v --cov=src

    - name: æ£€æŸ¥PRæž„å»ºé…ç½®
      run: |
        echo "ðŸ“‹ æ£€æŸ¥PRæž„å»ºä¿¡æ¯..."
        echo "PRç¼–å·: ${{ github.event.number }}"
        echo "æºåˆ†æ”¯: ${{ github.head_ref }}"
        echo "ç›®æ ‡åˆ†æ”¯: ${{ github.base_ref }}"
        echo "å½“å‰æäº¤: ${{ github.sha }}"


        # æ£€æŸ¥å›¾æ ‡æ–‡ä»¶
        echo "ðŸŽ¨ æ£€æŸ¥åº”ç”¨å›¾æ ‡æ–‡ä»¶..."
        ls -la src/resources/icons/

        # éªŒè¯PyInstallerçŽ¯å¢ƒ
        echo "ðŸ”§ éªŒè¯PyInstallerçŽ¯å¢ƒ..."
        pip install pyinstaller pyinstaller-hooks-contrib
        python -c "import PyInstaller; print(f'PyInstaller: {PyInstaller.__version__}')"

  # Windowsæž„å»º - ç”Ÿæˆå•exeå’Œç›®å½•åŽ‹ç¼©åŒ…
  build-windows:
    name: æž„å»ºWindowsç‰ˆæœ¬
    needs: pre-release-check
    runs-on: windows-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: 'x64'

    - name: å®‰è£…Visual C++è¿è¡Œæ—¶
      run: |
        echo "ðŸ”§ å®‰è£…Visual C++è¿è¡Œæ—¶..."
        # ä½¿ç”¨chocolateyå®‰è£…VC++è¿è¡Œæ—¶ï¼Œç¡®ä¿PyQt6èƒ½æ­£å¸¸å·¥ä½œ
        choco install vcredist-all -y
        echo "âœ… Visual C++è¿è¡Œæ—¶å®‰è£…å®Œæˆ"

    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip

        # å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆä½¿ç”¨ä¸Žæœ¬åœ°ç›¸åŒçš„ç‰ˆæœ¬ï¼‰
        pip install -r requirements.txt

        # å®‰è£…PyInstallerï¼ˆä½¿ç”¨ä¸Žæœ¬åœ°ç›¸åŒçš„ç‰ˆæœ¬ï¼‰
        pip install pyinstaller==6.14.2 pyinstaller-hooks-contrib

    - name: éªŒè¯ä¾èµ–å®‰è£…
      run: |
        python -c "import PyQt6.QtCore; print('PyQt6.QtCore: OK')"
        python -c "import PyQt6.QtQml; print('PyQt6.QtQml: OK')"
        python -c "import PyInstaller; print(f'PyInstaller: {PyInstaller.__version__}')"

    - name: æž„å»ºå•æ–‡ä»¶exe
      run: |
        echo "ðŸ”¨ æž„å»ºWindowså•æ–‡ä»¶exe..."
        pyinstaller `
          --onefile `
          --windowed `
          --icon=src/resources/icons/app.ico `
          --name=EmailDomainManager `
          --collect-all PyQt6 `
          --add-data "src/resources;resources" `
          --add-data "src/views/qml;views/qml" `
          --paths src `
          src/main.py

        # éªŒè¯æž„å»ºç»“æžœ
        if (Test-Path "dist/EmailDomainManager.exe") {
          $size = (Get-Item "dist/EmailDomainManager.exe").Length / 1MB
          Write-Host "âœ… å•æ–‡ä»¶exeæž„å»ºæˆåŠŸï¼Œå¤§å°: $([math]::Round($size, 1))MB"
        } else {
          Write-Host "âŒ å•æ–‡ä»¶exeæž„å»ºå¤±è´¥"
          exit 1
        }

    - name: æž„å»ºç›®å½•ç‰ˆæœ¬
      run: |
        echo "ðŸ”¨ æž„å»ºWindowsç›®å½•ç‰ˆæœ¬..."
        # æ¸…ç†ä¹‹å‰çš„æž„å»º
        Remove-Item -Recurse -Force build -ErrorAction SilentlyContinue

        pyinstaller `
          --onedir `
          --windowed `
          --icon=src/resources/icons/app.ico `
          --name=EmailDomainManager-Portable `
          --collect-all PyQt6 `
          --add-data "src/resources;resources" `
          --add-data "src/views/qml;views/qml" `
          --paths src `
          src/main.py

        # éªŒè¯æž„å»ºç»“æžœ
        if (Test-Path "dist/EmailDomainManager-Portable/EmailDomainManager-Portable.exe") {
          Write-Host "âœ… ç›®å½•ç‰ˆæœ¬æž„å»ºæˆåŠŸ"
        } else {
          Write-Host "âŒ ç›®å½•ç‰ˆæœ¬æž„å»ºå¤±è´¥"
          exit 1
        }

    - name: åˆ›å»ºWindowså‘å¸ƒåŒ…
      run: |
        echo "ðŸ“¦ åˆ›å»ºWindowså‘å¸ƒåŒ…..."

        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path "release"

        # 1. å•æ–‡ä»¶exe - ç›´æŽ¥å¤åˆ¶
        Copy-Item "dist/EmailDomainManager.exe" "release/EmailDomainManager-Windows-x64.exe"

        # 2. ä¾¿æºç‰ˆ - åŽ‹ç¼©æ•´ä¸ªç›®å½•
        $compress = @{
          Path = "dist/EmailDomainManager-Portable/*"
          CompressionLevel = "Optimal"
          DestinationPath = "release/EmailDomainManager-Windows-x64-Portable.zip"
        }
        Compress-Archive @compress

        # æ˜¾ç¤ºç»“æžœ
        Write-Host "ðŸ“ Windowså‘å¸ƒæ–‡ä»¶:"
        Get-ChildItem "release" | ForEach-Object {
          $size = $_.Length / 1MB
          Write-Host "  $($_.Name): $([math]::Round($size, 1))MB"
        }

        Write-Host ""
        Write-Host "ðŸ“‹ å‘å¸ƒè¯´æ˜Ž:"
        Write-Host "  - å•æ–‡ä»¶exe: åŒå‡»å³å¯è¿è¡Œï¼Œå¯åŠ¨è¾ƒæ…¢"
        Write-Host "  - ä¾¿æºç‰ˆzip: è§£åŽ‹åŽè¿è¡Œï¼Œå¯åŠ¨è¾ƒå¿«"

    - name: ä¸Šä¼ Windowsæž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: windows-builds
        path: release/*
        retention-days: 30

  # Ubuntuæž„å»º - ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶å’Œtar.gzåŒ…
  build-ubuntu:
    name: æž„å»ºUbuntuç‰ˆæœ¬
    needs: pre-release-check
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        echo "ðŸ“¦ å®‰è£…Ubuntuç³»ç»Ÿä¾èµ–..."
        sudo apt-get update

        # å®‰è£…PyQt6è¿è¡Œæ—¶ä¾èµ–
        sudo apt-get install -y \
          libgl1-mesa-glx \
          libgl1-mesa-dev \
          libglib2.0-0 \
          libglib2.0-dev \
          libxkbcommon-x11-0 \
          libxkbcommon-dev \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-xfixes0 \
          libxcb-shape0 \
          libxcb-sync1 \
          libxcb-shm0 \
          libxcb-util1 \
          libxcb-cursor0 \
          libfontconfig1 \
          libfontconfig1-dev \
          libfreetype6 \
          libfreetype6-dev \
          libx11-6 \
          libx11-dev \
          libx11-xcb1 \
          libxext6 \
          libxext-dev \
          libxrender1 \
          libxrender-dev \
          libegl1-mesa \
          libegl1-mesa-dev \
          libxss1 \
          libasound2 \
          libasound2-dev \
          libpulse0 \
          libpulse-dev \
          libdrm2 \
          libdrm-dev \
          libxcomposite1 \
          libxcomposite-dev \
          libxdamage1 \
          libxdamage-dev \
          libxrandr2 \
          libxrandr-dev \
          libxtst6 \
          libxtst-dev

        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: å®‰è£…Pythonä¾èµ–
      run: |
        echo "ðŸ å®‰è£…Pythonä¾èµ–..."
        python -m pip install --upgrade pip

        # å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆä½¿ç”¨ä¸Žæœ¬åœ°ç›¸åŒçš„ç‰ˆæœ¬ï¼‰
        pip install -r requirements.txt

        # å®‰è£…PyInstallerï¼ˆä½¿ç”¨ä¸Žæœ¬åœ°ç›¸åŒçš„ç‰ˆæœ¬ï¼‰
        pip install pyinstaller==6.14.2 pyinstaller-hooks-contrib

        echo "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"

    - name: éªŒè¯ä¾èµ–å®‰è£…
      run: |
        echo "ðŸ” éªŒè¯ä¾èµ–å®‰è£…..."
        python -c "import PyQt6.QtCore; print('PyQt6.QtCore: OK')"
        python -c "import PyQt6.QtGui; print('PyQt6.QtGui: OK')"
        python -c "import PyQt6.QtQml; print('PyQt6.QtQml: OK')"
        python -c "import PyQt6.QtQuick; print('PyQt6.QtQuick: OK')"
        python -c "from PyQt6.QtCore import qVersion; print(f'Qt6 version: {qVersion()}')"
        python -c "import PyInstaller; print(f'PyInstaller: {PyInstaller.__version__}')"
        echo "âœ… æ‰€æœ‰ä¾èµ–éªŒè¯é€šè¿‡"

    - name: æž„å»ºUbuntuå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        echo "ðŸ”¨ æž„å»ºUbuntuå¯æ‰§è¡Œæ–‡ä»¶..."
        pyinstaller \
          --onedir \
          --windowed \
          --icon=src/resources/icons/app.png \
          --name=EmailDomainManager \
          --collect-all PyQt6 \
          --add-data "src/resources:resources" \
          --add-data "src/views/qml:views/qml" \
          --paths src \
          src/main.py

        # éªŒè¯æž„å»ºç»“æžœ
        if [ -f "dist/EmailDomainManager/EmailDomainManager" ]; then
          chmod +x dist/EmailDomainManager/EmailDomainManager
          size=$(stat -c%s "dist/EmailDomainManager/EmailDomainManager")
          size_mb=$((size / 1024 / 1024))
          echo "âœ… Ubuntuå¯æ‰§è¡Œæ–‡ä»¶æž„å»ºæˆåŠŸï¼Œå¤§å°: ${size_mb}MB"

          # æ£€æŸ¥æ–‡ä»¶ä¿¡æ¯
          file dist/EmailDomainManager/EmailDomainManager
          echo "ðŸ“ æž„å»ºç›®å½•å†…å®¹:"
          ls -la dist/EmailDomainManager/
        else
          echo "âŒ Ubuntuå¯æ‰§è¡Œæ–‡ä»¶æž„å»ºå¤±è´¥"
          echo "ðŸ“ distç›®å½•å†…å®¹:"
          ls -la dist/ || echo "distç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi

    - name: åˆ›å»ºUbuntuå‘å¸ƒåŒ…
      run: |
        echo "ðŸ“¦ åˆ›å»ºUbuntuå‘å¸ƒåŒ…..."

        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release

        # åˆ›å»ºå®‰è£…åŒ…ç›®å½•
        mkdir -p EmailDomainManager-Ubuntu-x64
        cp -r dist/EmailDomainManager/* EmailDomainManager-Ubuntu-x64/

        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > EmailDomainManager-Ubuntu-x64/run.sh << 'EOF'
        #!/bin/bash
        # åŸŸåé‚®ç®±ç®¡ç†å™¨å¯åŠ¨è„šæœ¬

        # èŽ·å–è„šæœ¬æ‰€åœ¨ç›®å½•
        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

        # è¿è¡Œç¨‹åº
        cd "$DIR"
        ./EmailDomainManager "$@"
        EOF

        chmod +x EmailDomainManager-Ubuntu-x64/run.sh
        chmod +x EmailDomainManager-Ubuntu-x64/EmailDomainManager

        # åˆ›å»ºREADME
        cat > EmailDomainManager-Ubuntu-x64/README.txt << 'EOF'
        åŸŸåé‚®ç®±ç®¡ç†å™¨ Ubuntuç‰ˆæœ¬

        å®‰è£…è¯´æ˜Ž:
        1. è§£åŽ‹æ–‡ä»¶: tar -xzf EmailDomainManager-Ubuntu-x64.tar.gz
        2. è¿›å…¥ç›®å½•: cd EmailDomainManager-Ubuntu-x64
        3. è¿è¡Œç¨‹åº: ./EmailDomainManager æˆ– ./run.sh

        ç³»ç»Ÿè¦æ±‚:
        - Ubuntu 18.04+ æˆ–å…¶ä»–çŽ°ä»£Linuxå‘è¡Œç‰ˆ (x86_64)
        - 4GB+ RAM (æŽ¨è)
        - 100MB+ ç£ç›˜ç©ºé—´
        - X11æˆ–Waylandæ˜¾ç¤ºæœåŠ¡å™¨

        å¦‚é‡åˆ°ä¾èµ–é—®é¢˜ï¼Œè¯·å®‰è£…:
        sudo apt install libgl1-mesa-glx libglib2.0-0 libxkbcommon-x11-0 libfontconfig1 libfreetype6

        é¡¹ç›®ä¸»é¡µ: https://github.com/your-username/email-domain-manager
        EOF

        # åˆ›å»ºtar.gzåŒ…
        tar -czf release/EmailDomainManager-Ubuntu-x64.tar.gz EmailDomainManager-Ubuntu-x64/

        # æ˜¾ç¤ºç»“æžœ
        echo "ðŸ“ Ubuntuå‘å¸ƒæ–‡ä»¶:"
        ls -lh release/

        echo "âœ… Ubuntuå‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"

    - name: ä¸Šä¼ Ubuntuæž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ubuntu-builds
        path: release/*
        retention-days: 30


  # åˆ›å»ºGitHub Release
  create-release:
    name: åˆ›å»ºGitHub Release
    needs: [build-windows, build-ubuntu]
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½Windowsæž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: windows-builds
        path: artifacts/windows/

    - name: ä¸‹è½½Ubuntuæž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: ubuntu-builds
        path: artifacts/ubuntu/

    - name: æ•´ç†æž„å»ºäº§ç‰©
      run: |
        echo "ðŸ“ æ•´ç†æž„å»ºäº§ç‰©..."

        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release-files

        # å¤åˆ¶Windowsæž„å»ºäº§ç‰©
        if [ -d "artifacts/windows" ]; then
          echo "ðŸ“¦ Windowsæž„å»ºäº§ç‰©:"
          find artifacts/windows -type f -exec ls -lh {} \;
          cp artifacts/windows/* release-files/ 2>/dev/null || echo "æ— Windowsæ–‡ä»¶"
        fi

        # å¤åˆ¶Ubuntuæž„å»ºäº§ç‰©
        if [ -d "artifacts/ubuntu" ]; then
          echo "ðŸ“¦ Ubuntuæž„å»ºäº§ç‰©:"
          find artifacts/ubuntu -type f -exec ls -lh {} \;
          cp artifacts/ubuntu/* release-files/ 2>/dev/null || echo "æ— Ubuntuæ–‡ä»¶"
        fi

        echo "ðŸ“¦ æœ€ç»ˆå‘å¸ƒæ–‡ä»¶:"
        ls -lh release-files/ || echo "æ²¡æœ‰æ‰¾åˆ°å‘å¸ƒæ–‡ä»¶"

    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
      run: |
        echo "ðŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž..."

        # èŽ·å–æœ€æ–°çš„æäº¤ä¿¡æ¯ä½œä¸ºå‘å¸ƒè¯´æ˜Ž
        RELEASE_NOTES=$(git log --pretty=format:"- %s" -10)

        # æ ¹æ®äº‹ä»¶ç±»åž‹è®¾ç½®å‘å¸ƒç±»åž‹æ ‡è¯†
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          RELEASE_TYPE="ðŸ§ª æµ‹è¯•ç‰ˆæœ¬ (PR #${{ github.event.number }})"
          RELEASE_TITLE="åŸŸåé‚®ç®±ç®¡ç†å™¨ æµ‹è¯•ç‰ˆæœ¬"
        else
          RELEASE_TYPE="ðŸŽ‰ æ­£å¼å‘å¸ƒç‰ˆæœ¬"
          RELEASE_TITLE="åŸŸåé‚®ç®±ç®¡ç†å™¨ å¤šå¹³å°å‘å¸ƒç‰ˆæœ¬"
        fi

        cat > release-notes.md << EOF
        # $RELEASE_TITLE

        ## $RELEASE_TYPE

        ## ðŸŽ‰ æ–°åŠŸèƒ½å’Œæ”¹è¿›

        $RELEASE_NOTES

        ## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž

        ### Windowsç‰ˆæœ¬ (x86_64)
        - **å•æ–‡ä»¶exe**: \`EmailDomainManager-Windows-x64.exe\` - åŒå‡»å³å¯è¿è¡Œï¼Œæ— éœ€å®‰è£…ï¼Œå¯åŠ¨è¾ƒæ…¢
        - **ä¾¿æºç‰ˆ**: \`EmailDomainManager-Windows-x64-Portable.zip\` - è§£åŽ‹åŽè¿è¡Œï¼Œå¯åŠ¨æ›´å¿«ï¼ŒæŽ¨è

        ### Ubuntuç‰ˆæœ¬ (x86_64)
        - **å®Œæ•´åŒ…**: \`EmailDomainManager-Ubuntu-x64.tar.gz\` - åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶å’Œè¯´æ˜Žæ–‡æ¡£

        ## ðŸš€ å®‰è£…è¯´æ˜Ž

        ### Windowsç”¨æˆ·
        **æ–¹å¼1 - ä¾¿æºç‰ˆ (æŽ¨è)**:
        1. ä¸‹è½½ \`EmailDomainManager-Windows-x64-Portable.zip\`
        2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
        3. è¿è¡Œ \`EmailDomainManager-Portable.exe\`

        **æ–¹å¼2 - å•æ–‡ä»¶exe**:
        1. ä¸‹è½½ \`EmailDomainManager-Windows-x64.exe\`
        2. åŒå‡»exeæ–‡ä»¶ç›´æŽ¥è¿è¡Œï¼Œæ— éœ€å®‰è£…ï¼ˆå¯åŠ¨è¾ƒæ…¢ï¼‰

        ### Ubuntuç”¨æˆ·
        1. ä¸‹è½½ \`EmailDomainManager-Ubuntu-x64.tar.gz\`
        2. è§£åŽ‹: \`tar -xzf EmailDomainManager-Ubuntu-x64.tar.gz\`
        3. è¿›å…¥ç›®å½•: \`cd EmailDomainManager-Ubuntu-x64\`
        4. è¿è¡Œ: \`./EmailDomainManager\` æˆ– \`./run.sh\`

        ## ðŸ“‹ ç³»ç»Ÿè¦æ±‚

        ### Windows
        - Windows 10+ (x86_64)
        - 4GB+ RAM (æŽ¨è)
        - 100MB+ ç£ç›˜ç©ºé—´

        ### Ubuntu/Linux
        - Ubuntu 18.04+ æˆ–å…¶ä»–çŽ°ä»£Linuxå‘è¡Œç‰ˆ (x86_64)
        - 4GB+ RAM (æŽ¨è)
        - 100MB+ ç£ç›˜ç©ºé—´
        - X11æˆ–Waylandæ˜¾ç¤ºæœåŠ¡å™¨
        - å¦‚é‡ä¾èµ–é—®é¢˜: \`sudo apt install libgl1-mesa-glx libglib2.0-0 libxkbcommon-x11-0\`

        ## ðŸŽ¨ åº”ç”¨ç‰¹æ€§

        - åŸºäºŽPyQt6çš„çŽ°ä»£åŒ–ç•Œé¢
        - Material Designè®¾è®¡é£Žæ ¼
        - è·¨å¹³å°æ”¯æŒ (Windows/Linux)
        - å®Œæ•´çš„é‚®ç®±ç®¡ç†åŠŸèƒ½
        - å•æ–‡ä»¶exeå’Œä¾¿æºç‰ˆåŒé‡é€‰æ‹©

        ## ðŸ› é—®é¢˜åé¦ˆ

        å¦‚æœ‰é—®é¢˜è¯·åœ¨ [Issues](https://github.com/your-username/email-domain-manager/issues) ä¸­åé¦ˆã€‚
        EOF

    - name: ç¡®å®šç‰ˆæœ¬å·
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          # PRæµ‹è¯•ç‰ˆæœ¬ï¼šåŒ…å«PRç¼–å·
          VERSION="v$(date +'%Y.%m.%d')-pr${{ github.event.number }}-test${{ github.run_number }}"
        else
          # è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·ï¼švå¹´.æœˆ.æ—¥-æž„å»ºå·
          VERSION="v$(date +'%Y.%m.%d')-${{ github.run_number }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"

    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: åŸŸåé‚®ç®±ç®¡ç†å™¨ ${{ steps.version.outputs.version }}
        body_path: release-notes.md
        draft: false
        prerelease: ${{ github.event_name == 'pull_request' }}
        files: |
          release-files/EmailDomainManager-Windows-x64.exe
          release-files/EmailDomainManager-Windows-x64-Portable.zip
          release-files/EmailDomainManager-Ubuntu-x64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # éƒ¨ç½²æ–‡æ¡£ (ä¸´æ—¶å…è®¸PRè§¦å‘ï¼Œç”¨äºŽæµ‹è¯•)
  deploy-docs:
    name: éƒ¨ç½²æ–‡æ¡£
    needs: create-release
    runs-on: ubuntu-22.04  # æ˜Žç¡®æŒ‡å®šUbuntu 22.04
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: å®‰è£…æ–‡æ¡£å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install mkdocs mkdocs-material

    - name: æž„å»ºæ–‡æ¡£
      run: |
        echo "ðŸ“š æž„å»ºé¡¹ç›®æ–‡æ¡£..."

        # åˆ›å»ºmkdocsé…ç½®
        cat > mkdocs.yml << EOF
        site_name: åŸŸåé‚®ç®±ç®¡ç†å™¨
        site_description: åŸºäºŽPyQt6çš„åŸŸåé‚®ç®±ç®¡ç†å·¥å…· - å¤šå¹³å°è‡ªåŠ¨æ‰“åŒ…å‘å¸ƒ

        nav:
          - é¦–é¡µ: README.md
          - ä¸‹è½½å®‰è£…: docs/installation.md
          - ä½¿ç”¨æŒ‡å—: docs/user-guide.md
          - å¼€å‘æ–‡æ¡£: docs/development.md
          - APIè§„èŒƒ: docs/api-specification.md
          - æ›´æ–°æ—¥å¿—: docs/changelog.md

        theme:
          name: material
          language: zh
          palette:
            - scheme: default
              primary: blue
              accent: blue
              toggle:
                icon: material/brightness-7
                name: åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼
            - scheme: slate
              primary: blue
              accent: blue
              toggle:
                icon: material/brightness-4
                name: åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼
          features:
            - navigation.tabs
            - navigation.sections
            - navigation.expand
            - navigation.top
            - search.highlight
            - search.share
            - content.code.copy

        markdown_extensions:
          - pymdownx.highlight
          - pymdownx.superfences
          - pymdownx.tabbed
          - admonition
          - pymdownx.details
        EOF

        # åˆ›å»ºåŸºç¡€æ–‡æ¡£ç»“æž„
        mkdir -p docs

        # åˆ›å»ºå®‰è£…æ–‡æ¡£
        cat > docs/installation.md << EOF
        # ä¸‹è½½ä¸Žå®‰è£…

        ## æ”¯æŒçš„å¹³å°

        - Windows x86_64
        - Linux x86_64

        ## ä¸‹è½½åœ°å€

        è¯·è®¿é—® [GitHub Releases](https://github.com/your-username/email-domain-manager/releases) ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ã€‚

        ## å®‰è£…è¯´æ˜Ž

        ### Windows
        1. ä¸‹è½½ \`EmailDomainManager-windows-x86_64.zip\`
        2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
        3. åŒå‡» \`EmailDomainManager.exe\` è¿è¡Œ

        ### Linux
        1. ä¸‹è½½ \`EmailDomainManager-linux-x86_64.tar.gz\`
        2. è§£åŽ‹å¹¶è¿è¡Œ
        EOF

        mkdocs build

    - name: éƒ¨ç½²åˆ°GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site

  # æž„å»ºé€šçŸ¥å’Œæ€»ç»“
  build-notification:
    name: æž„å»ºé€šçŸ¥
    needs: [build-windows, build-ubuntu, create-release, deploy-docs]
    runs-on: ubuntu-22.04
    if: always()

    steps:
    - name: æž„å»ºç»“æžœé€šçŸ¥
      run: |
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "ðŸ” PRæž„å»ºæµ‹è¯•å’Œé¢„å‘å¸ƒå®Œæˆ"
          echo "========================"
          echo "PRä¿¡æ¯:"
          echo "  - PRç¼–å·: #${{ github.event.number }}"
          echo "  - æºåˆ†æ”¯: ${{ github.head_ref }}"
          echo "  - ç›®æ ‡åˆ†æ”¯: ${{ github.base_ref }}"
          echo "  - æµ‹è¯•ç‰ˆæœ¬: ${{ needs.create-release.outputs.version || 'æœªçŸ¥' }}"
        else
          echo "ðŸŽ‰ æ­£å¼å‘å¸ƒæµç¨‹å®Œæˆ"
          echo "========================"
        fi

        # æ£€æŸ¥æž„å»ºä»»åŠ¡ç»“æžœ
        echo "ðŸ“‹ ä»»åŠ¡æ‰§è¡Œç»“æžœ:"
        echo "  - Windowsæž„å»º: ${{ needs.build-windows.result }}"
        echo "  - Ubuntuæž„å»º: ${{ needs.build-ubuntu.result }}"

        if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "  - åˆ›å»ºRelease: ${{ needs.create-release.result }}"
          echo "  - éƒ¨ç½²æ–‡æ¡£: ${{ needs.deploy-docs.result }}"
        fi

        if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
          echo ""
          echo "âŒ æµç¨‹ä¸­å‡ºçŽ°é—®é¢˜"
          echo "å¤±è´¥çš„ä»»åŠ¡:"
          [[ "${{ needs.build-windows.result }}" == "failure" ]] && echo "  - Windowsæž„å»ºå¤±è´¥"
          [[ "${{ needs.build-ubuntu.result }}" == "failure" ]] && echo "  - Ubuntuæž„å»ºå¤±è´¥"
          [[ "${{ needs.create-release.result }}" == "failure" ]] && echo "  - åˆ›å»ºReleaseå¤±è´¥"
          [[ "${{ needs.deploy-docs.result }}" == "failure" ]] && echo "  - éƒ¨ç½²æ–‡æ¡£å¤±è´¥"
          echo ""
          echo "è¯·æ£€æŸ¥ä¸Šè¿°å¤±è´¥ä»»åŠ¡çš„æ—¥å¿—ä»¥èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚"
        else
          echo ""
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "âœ… PRæž„å»ºæµ‹è¯•å’Œé¢„å‘å¸ƒæˆåŠŸï¼"
            echo "ðŸ“¦ Windowså’ŒUbuntuå¹³å°æž„å»ºæˆåŠŸ"
            echo "ðŸŽ¯ å·²åˆ›å»ºæµ‹è¯•ç‰ˆæœ¬Releaseï¼Œå¯ä»¥ä¸‹è½½æµ‹è¯•"
            echo "âœ… æµ‹è¯•é€šè¿‡åŽå¯ä»¥å®‰å…¨åˆå¹¶åˆ°mainåˆ†æ”¯"
          else
            echo "ðŸŽ‰ æ­£å¼å‘å¸ƒæˆåŠŸå®Œæˆï¼"
            echo "ðŸ“¦ æ–°ç‰ˆæœ¬å·²å‘å¸ƒåˆ°GitHub Releases"
            echo "ðŸ“š æ–‡æ¡£å·²æ›´æ–°åˆ°GitHub Pages"
            echo ""
            echo "ðŸ”— ç›¸å…³é“¾æŽ¥:"
            echo "  - Releases: https://github.com/${{ github.repository }}/releases"
            echo "  - æ–‡æ¡£: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          fi
        fi

        echo ""
        echo "ðŸ“Š æž„å»ºç»Ÿè®¡:"
        echo "  - Windows: å•æ–‡ä»¶exe + ä¾¿æºç‰ˆzip"
        echo "  - Ubuntu: å•æ–‡ä»¶ + å®Œæ•´tar.gzåŒ…"
        echo "  - æž„å»ºæ—¶é—´: $(date)"
        echo "  - PRç¼–å·: #${{ github.event.number }}"
        echo "  - æºåˆ†æ”¯: ${{ github.head_ref }}"
        echo "  - æäº¤SHA: ${{ github.sha }}"
